name: 'Wait for Docker service (Windows)'
description: >
  Ensure the Docker daemon is running on Windows runners. Attempts to start the service if needed.
  Workaround for https://github.com/actions/runner-images/issues/13729

inputs:
  timeout:
    description: 'Maximum seconds to wait for the Docker service'
    required: false
    default: '120'
  start_after:
    description: 'Seconds to wait before forcefully starting the Docker service'
    required: false
    default: '30'

runs:
  using: "composite"
  steps:
    - name: Wait for Docker service
      run: |
        $timeout = [int]"${{ inputs.timeout }}"
        $startAfter = [int]"${{ inputs.start_after }}"
        $elapsed = 0
        $startAttempted = $false

        while ($elapsed -lt $timeout) {
          $svc = Get-Service docker -ErrorAction SilentlyContinue
          if ($svc -and $svc.Status -eq 'Running') {
            Write-Host "Docker service is running."
            docker version
            return
          }

          if (-not $svc) {
            Write-Host "Docker service not found. Installed services:"
            Get-Service *docker* | Format-Table -AutoSize
          }

          if ($elapsed -ge $startAfter -and -not $startAttempted) {
            Write-Host "Docker not available after ${startAfter}s â€” starting the service (see https://github.com/actions/runner-images/issues/13729)"
            Start-Service docker -ErrorAction SilentlyContinue
            $startAttempted = $true
          }

          Write-Host "Waiting for Docker service... ($elapsed s) status: $(if ($svc) { $svc.Status } else { 'not found' })"
          Start-Sleep 5
          $elapsed += 5
        }
        Write-Host "--- Diagnostics ---"
        Get-Service *docker* | Format-Table -AutoSize
        Get-EventLog -LogName Application -Source Docker* -Newest 10 -ErrorAction SilentlyContinue | Format-List
        Write-Error "Docker service not available after ${timeout}s"
        exit 1
      shell: pwsh
