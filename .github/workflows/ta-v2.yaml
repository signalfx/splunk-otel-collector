name: ta-v2 build and local smoke

on:
  push:
    branches:
      - main
    paths:
      - 'packaging/ta-v2/**'
      - '.github/workflows/ta-v2.yaml'
      - 'cmd/**'
      - 'internal/**'
      - 'pkg/**'
  pull_request:
    paths:
      - 'packaging/ta-v2/**'
      - '.github/workflows/ta-v2.yaml'
      - 'cmd/**'
      - 'internal/**'
      - 'pkg/**'
  workflow_dispatch: {}

env:
  GO_VERSION: 1.25.5

jobs:
  build-packages:
    name: Build TA v2 packages
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Build collector binaries (linux & windows)
        run: |
          set -eo pipefail
          make GOOS=linux GOARCH=amd64 otelcol
          install -D bin/otelcol_linux_amd64 packaging/ta-v2/assets/linux_x86_64/bin/Splunk_TA_OTel_Collector

          make GOOS=windows GOARCH=amd64 otelcol
          install -D bin/otelcol_windows_amd64 packaging/ta-v2/assets/windows_x86_64/bin/Splunk_TA_OTel_Collector.exe

      - name: Package TA v2
        working-directory: packaging/ta-v2
        run: |
          set -eo pipefail
          make all-packages
          ls -l ./out/distribution

      - name: Test package TA v2
        working-directory: packaging/ta-v2
        run: |
          set -eo pipefail
          make test-ta-v2

      - name: Upload TA v2 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ta-v2-packages
          path: packaging/ta-v2/out/distribution/*.tgz

  smoke-ta-v2:
    name: Smoke test TA v2 packages
    needs: build-packages
    strategy:
      matrix:
        runner: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.runner }}
    defaults:
        run:
            working-directory: ./packaging/ta-v2
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Download TA v2 artifacts
        uses: actions/download-artifact@v5
        with:
          name: ta-v2-packages
          path: packaging/ta-v2/out/distribution

      - name: Extract package
        shell: bash
        run: |
          set -eo pipefail
          mkdir -p ./build-out
          tar -xzf out/distribution/Splunk_TA_OTel_Collector.tgz -C ./build-out
          find ./build-out -name "*"

      - name: Run local container smoke (linux)
        if: matrix.runner == 'ubuntu-latest'
        env:
          ASSETS_DIR: ./build-out/Splunk_TA_OTel_Collector
        run: |
          sudo ./run-local-package-in-container.sh

      - name: Run local container smoke (windows)
        if: matrix.runner == 'windows-latest'
        shell: pwsh
        env:
          ASSETS_DIR: ./build-out/Splunk_TA_OTel_Collector
        run: |
          docker build -t splunk-uf-windows:latest -f ./Dockerfile.windows .
          ./run-local-package-in-container.ps1

      - name: Show splunkd.log on failure (Linux)
        if: failure() && matrix.runner == 'ubuntu-latest'
        shell: bash
        run: |
          set -eo pipefail
          echo "===== splunkd.log ====="
          sudo cat ./local-test-logs/var/log/splunk/splunkd.log
          echo "======================"

      - name: Show splunkd.log on failure (Windows)
        if: failure() && matrix.runner == 'windows-latest'
        shell: bash
        run: |
          set -eo pipefail
          echo "===== splunkd.log ====="
          cat ./local-test-logs/var/log/splunk/splunkd.log
          echo "======================"
