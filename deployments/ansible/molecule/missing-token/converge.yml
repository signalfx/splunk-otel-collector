---
- name: Converge (expect role failure without splunk_access_token)
  hosts: all
  gather_facts: true
  become: yes
  vars:
    local_artifact_testing_enabled: true
    splunk_realm: fake-realm
    start_service: false
  tasks:
    - name: "Include signalfx.splunk_otel_collector.collector role"
      include_role:
        name: "signalfx.splunk_otel_collector.collector"
      rescue:
        - name: Mark that expected failure happened
          ansible.builtin.set_fact:
            expected_token_failure: true

    - name: Assert the role failed due to missing splunk_access_token
      ansible.builtin.assert:
        that:
          - expected_token_failure | default(false)
        fail_msg: "Collector role did NOT fail when splunk_access_token was absent."
        success_msg: "Collector role correctly failed without splunk_access_token."
