---
- name: Verify scenario with auto-instrumentation installation
  hosts: all
  gather_facts: false
  tasks:
    - name: Populate service facts
      ansible.builtin.service_facts:

    - name: Assert splunk-otel-collector service is running
      assert:
        that: ansible_facts.services['splunk-otel-collector.service'].state == 'running'

    - name: Populate package facts
      ansible.builtin.package_facts:

    - name: Get splunk-otel-auto-instrumentation version
      set_fact:
        auto_instrumentation_version: "{{ ansible_facts.packages['splunk-otel-auto-instrumentation'][0].version }}"

    - name: Check if splunk-otel-js is installed
      shell: npm ls @splunk/otel
      args:
        chdir: /usr/lib/splunk-instrumentation/splunk-otel-js

    - name: Check for the old config file
      ansible.builtin.stat:
        path: /usr/lib/splunk-instrumentation/instrumentation.conf
      register: old_config

    - name: Assert the old config file does not exist
      assert:
        that: not old_config.stat.exists

    - name: Check for systemd drop-in file
      ansible.builtin.stat:
        path: /usr/lib/systemd/system.conf.d/00-splunk-otel-auto-instrumentation.conf
      register: systemd

    - name: Assert systemd drop-in file does not exist
      assert:
        that: not systemd.stat.exists

    - name: Assert /etc/ld.so.preload contains path to libsplunk.so
      ansible.builtin.lineinfile:
        line: /usr/lib/splunk-instrumentation/libsplunk.so
        dest: /etc/ld.so.preload
        state: present
      check_mode: yes
      register: preload
      failed_when: preload is changed

    - name: Assert /etc/ld.so.preload contains custom line
      ansible.builtin.lineinfile:
        line: '# my custom library'
        dest: /etc/ld.so.preload
        state: present
      check_mode: yes
      register: preload
      failed_when: preload is changed

    - name: Assert instrumentation config contains path to java agent
      ansible.builtin.lineinfile:
        line: JAVA_TOOL_OPTIONS=-javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
        dest: /etc/splunk/zeroconfig/java.conf
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed

    - name: Assert instrumentation config contains NODE_OPTIONS
      ansible.builtin.lineinfile:
        line: NODE_OPTIONS=-r /usr/lib/splunk-instrumentation/splunk-otel-js/node_modules/@splunk/otel/instrument
        dest: /etc/splunk/zeroconfig/node.conf
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed

    - name: Assert instrumentation config contains OTEL_RESOURCE_ATTRIBUTES
      ansible.builtin.lineinfile:
        line: "OTEL_RESOURCE_ATTRIBUTES=\
              splunk.zc.method=splunk-otel-auto-instrumentation-{{ auto_instrumentation_version }},\
              deployment.environment=test"
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf

    - name: Assert instrumentation config contains OTEL_SERVICE_NAME
      ansible.builtin.lineinfile:
        line: OTEL_SERVICE_NAME=test
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf

    - name: Assert instrumentation config contains SPLUNK_PROFILER_ENABLED
      ansible.builtin.lineinfile:
        line: SPLUNK_PROFILER_ENABLED=true
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf

    - name: Assert instrumentation config contains SPLUNK_PROFILER_MEMORY_ENABLED
      ansible.builtin.lineinfile:
        line: SPLUNK_PROFILER_MEMORY_ENABLED=true
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf

    - name: Assert instrumentation config contains SPLUNK_METRICS_ENABLED
      ansible.builtin.lineinfile:
        line: SPLUNK_METRICS_ENABLED=true
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf

    - name: Assert instrumentation config contains OTEL_EXPORTER_OTLP_ENDPOINT
      ansible.builtin.lineinfile:
        line: OTEL_EXPORTER_OTLP_ENDPOINT=http://0.0.0.0:4317
        dest: "/etc/splunk/zeroconfig/{{ item }}"
        state: present
      check_mode: yes
      register: config
      failed_when: config is changed
      loop:
        - java.conf
        - node.conf
