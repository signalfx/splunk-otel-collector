# Linux Java Auto Instrumentation

This directory contains functionality to automatically instrument your local Java applications so that they capture and
report distributed traces to Splunk APM.

## Operation

This directory contains functionality for building a Linux .so (shared object) file, which, in conjunction with a
reference to that file in
`/etc/ld.so.preload` (provided by an installer defined elsewhere) causes processes on the host to run this .so before
the main executable runs. If the executable that's starting is not named `java`, the .so quits silently and the
executable starts normally. Otherwise, it attempts to set two environment variables that will cause the
[Splunk OTel Java JAR](https://github.com/signalfx/splunk-otel-java) (also provided by the installer) to instrument the
soon-to-be running Java application. In this way, all Java applications on the host will be automatically instrumented
by the Splunk OTel Java agent.

Once instrumented, Java executables send traces to a locally running
[Splunk Open Telemetry Collector](https://github.com/signalfx/splunk-otel-collector)
(installed separately) and then on to Splunk APM.

### Environment Variables

The way the .so causes a Java executable to be instrumented is simply by setting two environment variables,
JAVA_TOOL_OPTIONS and OTEL_SERVICE_NAME.

#### JAVA_TOOL_OPTIONS

This environment variable contains a `-javaagent` flag set to the full path of the Splunk OTel Java JAR.

e.g. `JAVA_TOOL_OPTIONS='-javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar'`

#### OTEL_SERVICE_NAME

This environment variable sets the service name for the soon-to-be running Java application, usually derived from the
arguments of the Java executable (can be overridden via the config).

_Meta: link to docs about how service name is used and why it's required._

##### Service Name Generation

The OTEL_SERVICE_NAME environment variable is set to a value that the .so generates from the arguments passed to the
Java executable. The .so does this by reading the arguments to the Java application from left to right, ignoring
arguments that look like flags (that start with a `-`), and reading arguments containing `.jar`, splitting those on `:`,
then on `/`, removing known path parts such as `usr`, `local`, etc., truncating the `.jar` extension, replacing dots
with dashes, and concatenating the result with dashes. If while scanning the arguments, it finds a main class name, it
just returns the main class name with dots replaced with dashes and caps to lowercase, otherwise, it returns the munged
jar names.

For example, the following command:

```
/usr/bin/java -jar app/spring-petclinic-2.4.5.jar
```

produces a service name of:

```
app-spring-petclinic-2.4.5
```

The following, more complex command:

```
java -Djava.util.logging.config.file=\
/usr/local/apache-tomcat/8.5.4/conf/logging.properties \
-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager \
-Djdk.tls.ephemeralDHKeySize=2048 \
-classpath \
/usr/local/apache-tomcat/8.5.4/bin/bootstrap.jar:\
/usr/local/apache-tomcat/8.5.4/bin/tomcat-juli.jar \
-Dcatalina.base=/usr/local/apache-tomcat/8.5.4 \
-Dcatalina.home=/usr/local/apache-tomcat/8.5.4 \
-Djava.io.tmpdir=/usr/local/apache-tomcat/8.5.4/temp \
org.apache.catalina.startup.Bootstrap start
```

produces a service name of:

```
org-apache-catalina-startup-bootstrap
```

## Configuration File

At startup, the shared object reads the config file, `/usr/lib/splunk-instrumentation/instrumentation.conf` which by
default, looks like this:

```
java_agent_jar=/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
#service_name=my.service
```

The `java_agent_jar` parameter is set to the default location of the agent jar, and `service_name` is commented out.

### Supported parameters

#### `java_agent_jar` (required)

The full path to the auto instrumentation JAR (provided by the installer).

#### `service_name` (optional)

This is an optional override for the service name that would otherwise be generated by the shared object before Java
startup. By default, this line is commented out, but can be uncommented to override the generated name. If this
parameter is set, all instrumented Java applications on this host will have the specified service name (via the
OTEL_SERVICE_NAME environment variable).

### Syntax

To add a comment or comment out a line, start it with a `#`.

Not supported (and unnecessary) are:

* Quoting of any kind
* Whitespace on either side of the equals sign
* Leading whitespace

## Disabling

Short of uninstalling the package, there are a few safe ways of disabling auto instrumentation

* Set `DISABLE_SPLUNK_AUTOINSTRUMENTATION` to any non-empty value other than false, FALSE, or 0
* Set `JAVA_TOOL_OPTIONS` to some value that you want the JVM to pick up
* Delete or move the config `instrumentation.conf` file

## Files

* /usr/lib/splunk-instrumentation/libsplunk.so
* /usr/lib/splunk-instrumentation/instrumentation.conf
* /usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
