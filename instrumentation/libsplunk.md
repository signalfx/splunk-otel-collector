# Linux Java Auto Instrumentation

This directory contains functionality to automatically instrument your local Java applications so that they capture and
report distributed traces to Splunk APM.

## Operation

This directory contains functionality for building a Linux .so (shared object) file, which, in conjunction with a
reference to that file in
`/etc/ld.so.preload` (provided by an installer defined elsewhere) causes processes on the host to run this .so before
the main executable runs. If the executable that's starting is not named `java`, the .so quits silently and the
executable starts normally. Otherwise, it attempts to set environment variables that will cause the
[Splunk OTel Java JAR](https://github.com/signalfx/splunk-otel-java) (also provided by the installer) to instrument the
soon-to-be running Java application. In this way, all Java applications on the host will be automatically instrumented
by the Splunk OTel Java agent.

Once instrumented, Java executables send traces to a locally running
[Splunk Open Telemetry Collector](https://github.com/signalfx/splunk-otel-collector)
(installed separately) and then on to Splunk APM.

## Configuration File

At startup, the shared object reads the config file, `/usr/lib/splunk-instrumentation/instrumentation.conf` which by
default, looks like this:

```
java_agent_jar=/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
```

The `java_agent_jar` parameter is set to the default location of the agent jar.

### Supported parameters

#### `java_agent_jar` (required)

The full path to the auto instrumentation JAR (provided by the installer).

#### `service_name` (optional)

This is an optional override for the service name that would otherwise be generated by the shared object before Java
startup. By default, this line is commented out, but can be uncommented to override the generated name. If this
parameter is set, all instrumented Java applications on this host will have the specified service name (via the
OTEL_SERVICE_NAME environment variable). If this override is set and `generate_service_name` is also explicitly set to
`false`, that parameter will win, and the service name will not be set.

#### `resource_attributes` (optional -- typically set by the installer script)

This value, if present, should contain a list of name-value pairs (separated by `=`s and pairs separated by `,`s) to 
which the .so will set the OTEL_RESOURCE_ATTRIBUTES environment variable. The OTEL_RESOURCE_ATTRIBUTES environment
variable will then be picked up by the Java instrumentation jar. Typically, it will be set to something like:

`resource_attributes=deployment.environment=test`

to set the deployment environment for the Splunk backend.

#### `disable_telemetry` (optional)

Set this value to `true` to disable the preloader from sending the `splunk.linux-autoinstr.executions` metric to the
local collector. Default: `false`.

#### `generate_service_name` (optional)

Set this value to `false` to prevent the preloader from setting the `OTEL_SERVICE_NAME` environment variable. If this
value is `false`, the preloader will not set `OTEL_SERVICE_NAME`, and the soon-to-be running Java instrumentation
library will attempt to set it instead (in the future, this will be the default behavior). Default: `true`.

#### `enable_profiler` (optional)

Set this value to `true` to pass `-Dsplunk.profiler.enabled=true` to the starting Java executable, which will enable
[AlwaysOn CPU Profiling](https://docs.splunk.com/Observability/apm/profiling/get-data-in-profiling.html).
Default: `false`.

#### `enable_profiler_memory` (optional)

Set this value to `true` to pass `-Dsplunk.profiler.memory.enabled=true` to the starting Java executable, which will
enable
[AlwaysOn Memory Profiling](https://docs.splunk.com/Observability/apm/profiling/get-data-in-profiling.html).
Default: `false`.

#### `enable_metrics` (optional)

Set this value to `true` to pass `-Dsplunk.metrics.enabled=true` to the starting Java executable, which will enable
[exporting metrics](https://github.com/signalfx/splunk-otel-java/blob/main/docs/metrics.md). Default: `false`.

### Syntax

To add a comment or comment out a line, start it with a `#`.

Not supported (and unnecessary) are:

* Quoting of any kind
* Whitespace on either side of the equals sign
* Leading whitespace

### Environment Variables

The way the .so causes a Java executable to be instrumented is by setting the environment variables, JAVA_TOOL_OPTIONS
and OTEL_SERVICE_NAME, and optionally, OTEL_RESOURCE_ATTRIBUTES.

#### JAVA_TOOL_OPTIONS

This environment variable contains a `-javaagent` flag set to the full path of the Splunk OTel Java JAR.

e.g. `JAVA_TOOL_OPTIONS='-javaagent:/usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar'`

This variable is populated by the .so by concatenating the `java_agent_jar` attribute in the config to a `-javaagent:`
prefix, and then appending any additional system properties specified in the configuration file.

#### OTEL_SERVICE_NAME

This environment variable sets the service name for the soon-to-be running Java application, usually derived from the
arguments of the Java executable (can be overridden via the config).

This variable is set directly from the `service_name` attribute in the config.

_Meta: link to docs about how service name is used and why it's required._

#### OTEL_RESOURCE_ATTRIBUTES

This environment variable contains a list of name-value pairs (separated by `=`s) passed on to the Java instrumentation
jar.

This variable is set directly from the optional `resource_attributes` attribute in the config.

##### Service Name Generation

The OTEL_SERVICE_NAME environment variable is set to a value that the .so generates from the arguments passed to the
Java executable. The .so does this by reading the arguments to the Java application from left to right, ignoring
arguments that look like flags (that start with a `-`), and reading arguments containing `.jar`, splitting those on `:`,
then on `/`, removing known path parts such as `usr`, `local`, etc., truncating the `.jar` extension, replacing dots
with dashes, removing segments, and concatenating the result with dashes. If while scanning the arguments, it finds a
main class name, it just returns the main class name with dots replaced with dashes and caps to lowercase, otherwise,
it returns the munged jar names.

For example, the following command:

```
/usr/bin/java -jar app/petclinic/spring-petclinic-2.4.5.jar
```

produces a service name of:

```
app-petclinic-spring-2.4.5
```

The following, more complex command:

```
java -Djava.util.logging.config.file=\
/usr/local/apache-tomcat/8.5.4/conf/logging.properties \
-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager \
-Djdk.tls.ephemeralDHKeySize=2048 \
-classpath \
/usr/local/apache-tomcat/8.5.4/bin/bootstrap.jar:\
/usr/local/apache-tomcat/8.5.4/bin/tomcat-juli.jar \
-Dcatalina.base=/usr/local/apache-tomcat/8.5.4 \
-Dcatalina.home=/usr/local/apache-tomcat/8.5.4 \
-Djava.io.tmpdir=/usr/local/apache-tomcat/8.5.4/temp \
org.apache.catalina.startup.Bootstrap start
```

produces a service name of:

```
org-apache-catalina-startup-bootstrap
```

## Disabling

Short of uninstalling the package, there are a few safe ways of disabling auto instrumentation

* Set `DISABLE_SPLUNK_AUTOINSTRUMENTATION` to any non-empty value other than false, FALSE, or 0
* Set `JAVA_TOOL_OPTIONS` to some value that you want the JVM to pick up
* Delete or move the config `instrumentation.conf` file

## Files

* /usr/lib/splunk-instrumentation/libsplunk.so
* /usr/lib/splunk-instrumentation/instrumentation.conf
* /usr/lib/splunk-instrumentation/splunk-otel-javaagent.jar
