#!/bin/bash

set -euo pipefail

SCRIPT_DIR="$( cd "$( dirname ${BASH_SOURCE[0]} )" && pwd )"
REPO_DIR="$( cd "$SCRIPT_DIR"/../../ && pwd )"
CUR_DIR="$PWD"

OTEL_VERSION="${OTEL_VERSION:-main}"
CORE_VERSION="${CORE_VERSION:-$OTEL_VERSION}"
CONTRIB_VERSION="${CONTRIB_VERSION:-$OTEL_VERSION}"

trap "cd $CUR_DIR" EXIT

for gomod in $( find "$REPO_DIR" -name "go.mod" | grep -v "/examples/" | sort ); do
    pushd "$( dirname "$gomod" )" >/dev/null

    OFS=$IFS
    IFS=$'\n'

    # update the replace directives to the new version
    lines="$( (grep 'github.com/open-telemetry/opentelemetry-collector-contrib/.* =>' "$gomod" | grep -v 'ignore-update-deps' | grep -v '^[[:space:]]*//') || true )"
    for line in $lines; do
        pkg="$( echo "$line" | awk '{print $1}' )"
        go mod edit -replace=${pkg}=${pkg}@${CONTRIB_VERSION}
        go mod tidy
    done

    IFS=$OFS

    if grep -q 'go.opentelemetry.io/collector ' "$gomod"; then
        go get go.opentelemetry.io/collector@${CORE_VERSION}
    fi

    if grep -q 'go.opentelemetry.io/collector/model ' "$gomod"; then
        go get go.opentelemetry.io/collector/model@${CORE_VERSION}
    fi

    go mod tidy

    popd >/dev/null
done
