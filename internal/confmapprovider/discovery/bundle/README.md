## bundle.d

`bundle.d` refers to the [`embed.FS`](https://pkg.go.dev/embed#hdr-File_Systems) config directory made available by the
[`bundle.BundledFS`](./bundledfs_others.go). It currently consists of all `./bundle.d/extensions/*.discovery.yaml` and
`./bundle.d/receivers/*.discovery.yaml` files that are generated by the `discoverybundler` cmd from YAML metadata files.

To construct the latest bundle.d contents before building the collector run:

```bash
$ make bundle.d
```

### Component Metadata YAML Files

All discovery config components are now defined using YAML metadata files in the `cmd/discoverybundler/metadata/` directory:

- `metadata/extensions/` - Extension component definitions
- `metadata/receivers/` - Receiver component definitions

Each metadata file contains:
- `component_id` - The OpenTelemetry component identifier
- `supported_platforms` - Platform support (`all` or `unix_only`)
- `properties_tmpl` - Template to generate the properties YAML for the component

Example `metadata/receivers/redis.yaml`:

```yaml
component_id: redis
supported_platforms: all
properties_tmpl: |
  enabled: true
  service_type: redis
  rule:
    docker_observer: type == "container" and port == 6379
    <...>
  status:
    <...>
    statements:
      - status: partial
        regexp: 'NOAUTH Authentication required.'
        message: |-
          Make sure your user credentials are correctly specified as an environment variable.
          ```
          {{ configPropertyEnvVar "password" "<password>" }}
          ```
```

### Adding New Components

To add a new discovery component:

1. **Create metadata file**: Add a new YAML file in the appropriate directory:
   - Extensions: `cmd/discoverybundler/metadata/extensions/<component-name>.yaml`
   - Receivers: `cmd/discoverybundler/metadata/receivers/<component-name>.yaml`

2. **Define metadata**: Include the required fields:
   ```yaml
   component_id: <component-name>
   supported_platforms: all  # or "unix_only" for Unix-only components
   properties_tmpl: |
     enabled: true
     # ... your template content
   ```

3. **Generate files**: Run `make bundle.d` to generate the discovery files

The filename (without extension) automatically becomes the template filename for the generated `.discovery.yaml` file.

### Platform Support

Components can specify platform support via the `supported_platforms` field:

- **`all`**: Component works on all platforms (Windows, Linux, macOS)
- **`unix_only`**: Component works only on Unix-like systems (excludes Windows)

This automatically controls inclusion in the platform-specific [bundledfs files](./bundledfs_windows.go):
- Windows build: Includes only components with `supported_platforms: all`
- Non-Windows builds: Includes all components

### Generated Output

After running `make bundle.d`, the metadata generates:

1. **Discovery files**: `bundle.d/receivers/redis.discovery.yaml` with templated content:
   ```yaml
   ##############################################################################################
   #                               Do not edit manually!                                        #
   # All changes must be made to associated .yaml metadata file before running 'make bundle.d'. #
   ##############################################################################################
   redis:
     enabled: true
     service_type: redis
     rule:
       docker_observer: type == "container" and port == 6379
     # ... resolved template content with proper env var formatting
   ```

2. **Embedded filesystem**: Platform-appropriate `bundledfs_*.go` files with embedded file lists

When building the collector afterward, this redis receiver discovery config is now made available to discovery mode, and
it can be disabled by `--set splunk.discovery.receivers.redis.enabled=false` or
`SPLUNK_DISCOVERY_RECEIVERS_redis_ENABLED=false`.
